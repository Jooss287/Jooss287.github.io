<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="PCISample 함수 분석" /><meta name="author" content="SeongsooJoo" /><meta property="og:locale" content="en_US" /><meta name="description" content="DriverEntry" /><meta property="og:description" content="DriverEntry" /><link rel="canonical" href="https://jooss287.github.io/posts/PCISample_code_analysis/" /><meta property="og:url" content="https://jooss287.github.io/posts/PCISample_code_analysis/" /><meta property="og:site_name" content="Jooss’s HardDisk" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-08-21T18:30:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="PCISample 함수 분석" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@SeongsooJoo" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"SeongsooJoo"},"headline":"PCISample 함수 분석","dateModified":"2021-04-28T18:00:52+09:00","datePublished":"2020-08-21T18:30:00+09:00","description":"DriverEntry","url":"https://jooss287.github.io/posts/PCISample_code_analysis/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://jooss287.github.io/posts/PCISample_code_analysis/"},"@context":"https://schema.org"}</script><title>PCISample 함수 분석 | Jooss's HardDisk</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://cdn.jsdelivr.net/gh/cotes2020/chirpy-images/commons/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Jooss's HardDisk</a></div><div class="site-subtitle font-italic">Studies, Memos, Organizes</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/Jooss287" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['jooss287','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>PCISample 함수 분석</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>PCISample 함수 분석</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Aug 21, 2020, 6:30 PM +0900" > Aug 21, 2020 <i class="unloaded">2020-08-21T18:30:00+09:00</i> </span> by <span class="author"> SeongsooJoo </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Apr 28, 2021, 6:00 PM +0900" > Apr 28 <i class="unloaded">2021-04-28T18:00:52+09:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2164 words">12 min</span></div></div><div class="post-content"><h2 id="driverentry">DriverEntry</h2><ul><li><code class="language-plaintext highlighter-rouge">DriverUnload</code>: Unload 루틴 포인터, Unload 시 해다 함수 실행<li><code class="language-plaintext highlighter-rouge">DriverExtension</code>: Dirver Extension pointer. <code class="language-plaintext highlighter-rouge">AddDevice</code>을 통해서 드라이버 확장 루틴 진행<li><code class="language-plaintext highlighter-rouge">MajorFunction</code>: Driver의 Dispatch루틴에 대한 진입경로, 드라이버가 처리하는 <code class="language-plaintext highlighter-rouge">IRP_MJ_XXX</code>요청에 대한 pointer를 설정해야 합니다.</ul><h2 id="pcie_adddevice">PCIe_AddDevice</h2><ul><li><code class="language-plaintext highlighter-rouge">IoCreateDevice</code>: pDriver 생성<li><code class="language-plaintext highlighter-rouge">RtlZeroMemory</code>: memory 0으로 초기화 매크로<li><code class="language-plaintext highlighter-rouge">InitializeListHead</code>: List_Entry structure 초기화(head 생성)<li><code class="language-plaintext highlighter-rouge">IoInitializeDpcRequest</code>: DcpForIsr 등록<li><code class="language-plaintext highlighter-rouge">KeSetEvent</code>: set event object<li><code class="language-plaintext highlighter-rouge">PoSetPowerState</code>: Device power state에 대한 상태를 정의<li><code class="language-plaintext highlighter-rouge">IoAttachDeviceToDeviceStack</code>: Attach 성공 시 호출자의 최상위 device object를 반환<li><code class="language-plaintext highlighter-rouge">IoRegisterDeviceInterface</code>: Application에서 접근하는 GUID를 등록합니다.<li><code class="language-plaintext highlighter-rouge">pFDO-&gt;Flag</code>: bitwise를 사용하여 관련된 값 설정</ul><blockquote><p>DO_BUFFERED_IO/DO_DIRECT_IO: I/O Manager가 사용하는 버퍼링의 타입을 지정<br /> DO_POWER_PAGABLE: 항상 보장된 Thread의 문맥 아래에서만 PowerManager의 명령어를 받는다.<br /> DO_POWER_INRUSH: Thread의 문맥과 상관없이 언제든 PowerManager의 IRP를 받는다.<br /> DO_DEVICE_INITIALIZING: IoCreateDevice()를 통해 생성된 직후의 DeviceObject는 모두 이 값을 가진다.</p></blockquote><p>드라이버 마다 디바이스를 관리하기 위해 디바이스 오브젝트를 생성한다. 그리고 이러한 디바이스 오브젝트들이 순서를 가지고 쌓여서 디바이스 스택이 된다.</p><h3 id="dpcroutine">DPCRoutine</h3><ul><li><code class="language-plaintext highlighter-rouge">KeSetEvent</code>: 이벤트를 세팅합니다(?) - 조금 더 알아봐야할 듯</ul><h2 id="pcie_pnpdispatch">PCIe_PnPDispatch</h2><h3 id="irp_mj_pnp">IRP_MJ_PNP</h3><p>Plug and Play Manager에서 MajorFunction Code로 IRP_MJ_PNP를 발생시켜 해당 함수를 실행시키게 합니다. IRP: I/O request packet</p><ul><li><code class="language-plaintext highlighter-rouge">IoGetCurrentIrpStackLocation</code>: 지정된 IRP에서 호출자의 I/O Stack 위치에 대한 포인터를 반환<li><code class="language-plaintext highlighter-rouge">IoCallDriver</code>: 소유하고 있던 IRP를 연결된 다른 디바이스 오브젝트로 소유권을 이전합니다.</ul><h3 id="when-minor-code-sent">When Minor Code Sent</h3><ul><li><code class="language-plaintext highlighter-rouge">IRP_MM_START_DEVICE</code>: device가 시작 및 재시작 될 때 발생합니다.<li><code class="language-plaintext highlighter-rouge">IRP_MN_QUERY_PNP_DEVICE_STATE</code>: 초기 START_DEVICE가 성공적으로 실행 후 발생합니다.<li><code class="language-plaintext highlighter-rouge">IRP_MN_STOP_DEVICE</code>: 디바이스를 중지시킬때 발생합니다. 이 때 디바이스 하드웨어 리소스를 재구성할 수 있습니다. Windows2000이후의 시스템에서 QUERY_STOP_DEVICE가 성공적으로 완료된 이후에만 해당 IRP를 발생시킵니다.<li><code class="language-plaintext highlighter-rouge">IRP_MN_QUERY_REMOVE_DEVICE</code>: 드라이버가 컴퓨터에서 장치를 제거 할 예정임을 알리고 컴퓨터를 방해하지 않고 장치를 제거 할 수 있는지 여부를 쿼리합니다.<li><code class="language-plaintext highlighter-rouge">IRP_MN_CANCEL_REMOVE_DEVICE</code>: 디바이스가 제거되지 않음을 알리는 IRP입니다.<li><code class="language-plaintext highlighter-rouge">IRP_MN_REMOVE_DEVICE</code>: Device의 드라이버를 삭제하도록 할때 IRP를 발생시킵니다. 또한 오래된 버전을 제거하거나 유저가 업데이트를 요청 할 때 발생하기도 합니다. Windows2000이후의 시스템에서 START_DEVICE가 실패 할 경우에도 발생합니다.<li><code class="language-plaintext highlighter-rouge">IRP_MN_SURPRISE_REMOVAL</code>: I/O operations를 더이상 사용 할 수 없을 때 이 메세지를 발생시킵니다. 사용자 모드 응용 프로그램이나 다른 커널 모드 구성 요소에 알리기 전에 이 메세지를 발생시킵니다. 이 IRP가 완료된 후 등록 된 응용 프로그램 및 드라이버에 장치가 제거되었음을 알립니다.</ul><h3 id="startdevice">StartDevice</h3><ul><li><code class="language-plaintext highlighter-rouge">KeInitializeEvent</code>: Event Object 초IoConnectInterrupt기화<li><code class="language-plaintext highlighter-rouge">IoCopyCurrentIrpStackLocationToNext</code>: 하위 드라이버의 스택 위치에 IRP 스택 파라미터를 복사합니다.<li><code class="language-plaintext highlighter-rouge">IoSetCompletionRoutine</code>: 주어진 IRP에서 Next-Lower-level driver 동작 요청이 완료되었을 경우 실행 할 루틴 지정<li><code class="language-plaintext highlighter-rouge">KeWaitForSingleObject</code>: 주어진 dispatcher가 signaled state나 timeout이 될 때까지 thread를 대기상태로 둡니다.<li><code class="language-plaintext highlighter-rouge">MmMapIoSpace</code>: PhysicalAddress 메모리를 지정합니다. 물리메모리공간을 위한 가상주소를 매핑합니다.<li><code class="language-plaintext highlighter-rouge">IoConnectInterrupt</code>: Device Driver의 Interrupt Service Routine(ISR)을 등록합니다.<li><code class="language-plaintext highlighter-rouge">IoSetDeviceInterfaceState</code>: 응용 프로그램이 연결될 이름을 지정/금지 합니다. 지정 시 Win32 CreateFile()함수를 사용 할 수 있습니다.</ul><h4 id="interrupt-service-routine">Interrupt Service Routine</h4><ul><li><code class="language-plaintext highlighter-rouge">IoRequestDpc</code>: 드라이버에서 제공하는 lower-IRQL들을 관리합니다.(?)</ul><h3 id="stopdevice">StopDevice</h3><ul><li><code class="language-plaintext highlighter-rouge">IoSkipCurrentIrpStackLocation</code>: 현재 IRP의 스택을 다음 계층의 드라이버를 위해 소유권을 포기합니다.</ul><h3 id="removedevice">RemoveDevice</h3><ul><li><code class="language-plaintext highlighter-rouge">IoDisconnectInterrupt</code>: Device가 멈추거나 제거되었을 때 Device Driver의 인터럽트 오브젝트를 Release합니다.<li><code class="language-plaintext highlighter-rouge">RtlFreeUnicodeString</code>: RtlAnsiStringToUnicodeString 이나 RtlUpcaseUnicodeString로 설정된 메모리 버퍼를 해제합니다.<li><code class="language-plaintext highlighter-rouge">IoDetachDevice</code>: 호출된 Device Object와 Lower Driver’s Object의 연결을 해제시킵니다.<li><code class="language-plaintext highlighter-rouge">IoDeleteDevice</code>: 시스템에서 device object를 제거합니다.</ul><h2 id="pcie_powerdispatch">PCIe_PowerDispatch</h2><ul><li><code class="language-plaintext highlighter-rouge">PoStartNextPowerIrp</code>: 전원 드라이버가 준비되었음을 알리는 명령함수<li><code class="language-plaintext highlighter-rouge">PoCallDriver</code>: power IRP를 device stack 안의 next-lower driver로 전달한다.(?)</ul><h2 id="pcie_cleanup">PCIe_Cleanup</h2><ul><li><code class="language-plaintext highlighter-rouge">MmUnmapLockedPages</code>: 선행 호출된 <code class="language-plaintext highlighter-rouge">MmMapLockedPages</code>를 해제합니다.<li><code class="language-plaintext highlighter-rouge">IoFreeMdl</code>: 호출자 할장된 Memory Descriptor list(MDL)을 해제합니다.<li><code class="language-plaintext highlighter-rouge">MmFreeContiguousMemory</code>: Physically continuous memory 범위를 해제합니다.<li><code class="language-plaintext highlighter-rouge">MmUnMapIoSpace</code>: <code class="language-plaintext highlighter-rouge">MmMapIoSpace</code>을 통해 매핑된 주소를 해제합니다.<li><code class="language-plaintext highlighter-rouge">ExFreePool</code>: Pool 메모리 블록을 해제합니다.</ul><h2 id="pcie_devicecontrol">PCIe_DeviceControl</h2><h3 id="ctl_code--io-control-codes">CTL_CODE (I/O Control Codes)</h3><p>유저모드와 드라이버간에 통신을 위해 설정하는 매크로입니다. 유저모드의 어플리케이션은 DeviceControl IRP를 호출함으로써 IOCTL을 전달합니다.</p><h4 id="method-parameter">Method parameter</h4><blockquote><ul><li>METHOD_BUFFERED: DeviceControl()함수에서 제공하는 입력 버퍼와 출력 버퍼를 Buffered I/O 방식으로 처리<li>METHOD_IN_DIRECT/METHOD_OUT_DIRECT: DeviceControl()함수에서 제공되는 입력 버퍼를 Buffered I/O방식으로 처리하고 출력 버퍼를 Direct I/O방식으로 처리</ul><blockquote><p>METHOD_IN_DIRECT: I/O 관리자는 I/O를 요청한 스레드가 출력 버퍼에 대한 읽기 권한을 가지고 있는지 조사<br /> METHOD_OUT_DIRECT: I/O 관리자는 I/O를 요청한 스레드가 출력 버퍼에 대한 쓰기 권한을 가지고 있는지 조사</p></blockquote><ul><li>METHOD_NEITHER: DeviceControl()함수에서 제공되는 입력 버퍼와 출력 버퍼를 Neighter I/O 방식으로 처리</ul></blockquote><h4 id="mdl">MDL</h4><p><code class="language-plaintext highlighter-rouge">MDL(Memory Descriptor List)</code>: 가상 메모리가 어떤 물리메모리와 연결되어 있는지 보여주는 기능을 합니다.</p><ul><li>Direct I/O: MDL구조체를 사용하여 I/O를 요청한 스레드의 물리 주소 공간에 위치한 데이터를 가리키는 방식<li>Buffered I/O: 버퍼에 저장된 I/O가 요청한 스레드의 주소 공간에 시스템 주소 공간에 있는 임시 영역으로 복사되고, 드라이버는 복사된 데이터의 버퍼 포인터를 사용하는 방식<li>Neither I/O: 드라이버는 버퍼에 해당하는 I/O를 요청한 스레드의 가상 주소를 제공하는 방식</ul><div class="table-wrapper"><table><thead><tr><th> <th style="text-align: center">Direct I/O<th style="text-align: center">Buffered I/O<th style="text-align: center">Neither I/O<tbody><tr><td>데이터 버퍼 위치<td style="text-align: center">MDL 구조체<td style="text-align: center">시스템 영역에 있는 인터미디어트 버퍼<td style="text-align: center">I/O를 요청한 스레드의 가상 주소<tr><td>데이터 보호<td style="text-align: center">I/O 관리자가 데이터 보호<td style="text-align: center">데이터 보호하지 않음<td style="text-align: center">데이터 보호하지 않음<tr><td>IRP 내의 데이터 저장 필드<td style="text-align: center">Irp-&gt;MdlAddress<td style="text-align: center">Irp-&gt;AssociatedIrp<td style="text-align: center">Irp-&gt;UserBuffer<tr><td>페이징 I/O<td style="text-align: center">불가능<td style="text-align: center">가능<td style="text-align: center">가능<tr><td>컨텍스트<td style="text-align: center">임의의 스레드 컨텍스트<td style="text-align: center">임의의 스레드 컨텍스트<td style="text-align: center">I/O를 요청한 스레드 컨텍스트</table></div><p><a href="https://tmsen.tistory.com/entry/MDL-%EC%BB%A4%EB%84%90-%EB%B2%84%ED%8D%BC">Reference</a></p><h4 id="ioctl_mapping_memory">IOCTL_Mapping_Memory</h4><ul><li><code class="language-plaintext highlighter-rouge">IoAllocateMdl</code>: 주어진 버퍼의 시작주소와 길이를 사용하여 충분한 MDL을 설정합니다.<li><code class="language-plaintext highlighter-rouge">MmBuildMdlForNonPagedPool</code>: 메모리가 설정되지 않은 Virtual memory buffer를 지정합니다. 매개변수로 받는 MDL은 <code class="language-plaintext highlighter-rouge">IoAllocateMdl</code>을 사용하여 버퍼에 대해 MDL을 작성해야만 합니다.<li><code class="language-plaintext highlighter-rouge">MmMapLockedPages</code>: 주어진 MDL의 physical page을 매핑합니다. (Windows 2000이후 버전에서는 사용하지 않는 함수입니다.)<li><code class="language-plaintext highlighter-rouge">MmMapLockedPagesSpecifyCache</code>: 가상 주소로 MDL에 있는 물리 주소를 매핑합니다. 호출자는 매핑하는데 사용되는 캐시 속성을 지정하기 위해 호출 할 수 있습니다.(?)<li><code class="language-plaintext highlighter-rouge">ExAllocatePool</code>: Pool memory를 배분합니다.(msdn에서 <code class="language-plaintext highlighter-rouge">ExAllocatePoolWithTag</code> 를 쓰라고 합니다.)<li><code class="language-plaintext highlighter-rouge">ExAllocatePoolWithTag</code>: 지정된 타입에 대한 Pool Memory를 배분하고 정의된 블록에 대한 포인터를 반환합니다.<li><code class="language-plaintext highlighter-rouge">InsertTailList</code>: Doubly Linked List의 Tail에 데이터를 추가합니다.</ul><h4 id="ioctl_unmapping_memory">IOCTL_UnMapping_Memory</h4><ul><li><code class="language-plaintext highlighter-rouge">MmIsAddressValid</code>: page fault을 체크합니다. msdn에서는 이 함수의 사용을 추천하지 않습니다.<li><code class="language-plaintext highlighter-rouge">MmUnmapLockedPages</code>: <code class="language-plaintext highlighter-rouge">MmMapLockedPages</code>나 <code class="language-plaintext highlighter-rouge">MmMapLockedPagesSpecifyCache</code>로 매핑된 것들을 Release 합니다.<li><code class="language-plaintext highlighter-rouge">IoFreeMdl</code>: 호출자의 MDL을 Release 합니다.<li><code class="language-plaintext highlighter-rouge">MmUnmapIoSpace</code>: <code class="language-plaintext highlighter-rouge">MmMapIoSpace</code>로 매핑한 주소를 해제합니다.<li><code class="language-plaintext highlighter-rouge">RemoveEntryList</code>: Doubly linked list로 된 LIST_ENTRY를 제거합니다.<li><code class="language-plaintext highlighter-rouge">ExFreePool</code>: pool memory를 해제합니다.</ul><h4 id="ioctl_get_configuration_register">IOCTL_Get_Configuration_Register</h4><ul><li><code class="language-plaintext highlighter-rouge">IRP_MN_READ_CONFIG</code>:</ul><h3 id="ioctl_register_shared_event">IOCTL_Register_Shared_Event</h3><ul><li><code class="language-plaintext highlighter-rouge">ObReferenceObjectByHandle</code>: Object Handle 의 access 확인정보를 제공합니다. access 가능하다면 object의 body pointer 를 반환합니다.</ul><h4 id="ioctl_allocate_contiguous_memory_for_dma">IOCTL_Allocate_Contiguous_Memory_For_DMA</h4><ul><li><code class="language-plaintext highlighter-rouge">MmGetPhysicalAddress</code>:</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/language/'>Language</a>, <a href='/categories/c/'>C</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/windows-driver/" class="post-tag no-text-decoration" >windows driver</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=PCISample 함수 분석 - Jooss's HardDisk&url=https://jooss287.github.io/posts/PCISample_code_analysis/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=PCISample 함수 분석 - Jooss's HardDisk&u=https://jooss287.github.io/posts/PCISample_code_analysis/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=PCISample 함수 분석 - Jooss's HardDisk&url=https://jooss287.github.io/posts/PCISample_code_analysis/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/kmdf/">KMDF 정리</a><li><a href="/posts/wdm_Terminology/">WDM 용어 정리</a><li><a href="/posts/Build_driver/">Driver 빌드하기</a><li><a href="/posts/Make_Inf/">Driver Inf 작성하기, Driver 빌드하기</a><li><a href="/posts/WinDbg_How_to_use/">드라이버 디버깅 세팅하기</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/windows-driver/">windows driver</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/django/">django</a> <a class="post-tag" href="/tags/env-setting/">env setting</a> <a class="post-tag" href="/tags/commit/">commit</a> <a class="post-tag" href="/tags/tomcat/">tomcat</a> <a class="post-tag" href="/tags/unit-test/">unit test</a> <a class="post-tag" href="/tags/boost/">boost</a> <a class="post-tag" href="/tags/class/">class</a> <a class="post-tag" href="/tags/etc-recording/">etc recording</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/kmdf/"><div class="card-body"> <span class="timeago small" > Jul 20, 2020 <i class="unloaded">2020-07-20T18:30:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>KMDF 정리</h3><div class="text-muted small"><p> Kernel Mode Driver Development 지난번 TIL에서 Windows Driver Kit 개발 환경 세팅을 진행했습니다. Windows architecture를 공부함과 동시에 어떤식으로 Driver를 개발해야 하는지에 대해서도 지속적으로 공부중입니다. 공부하고 있는 것들을 간단하게나마 정리하고자 합니다. WDM과 WDF Win...</p></div></div></a></div><div class="card"> <a href="/posts/wdm_Terminology/"><div class="card-body"> <span class="timeago small" > Aug 4, 2020 <i class="unloaded">2020-08-04T18:30:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>WDM 용어 정리</h3><div class="text-muted small"><p> 파일 입출력과 IRP 응용 프로그램 단에서 드라이버와 통신을 하게 되면 드라이퍼를 ‘파일’로써 인식하고 Win32API 를 사용하여 통신을 하게 됩니다. Win32API의 CreateFile을 호출하게 되면 Dirver단에서 IRP_MJ_CREATE 명령어가 생성되어 드라이버에게 전달합니다. 또한 드라이버에서는 MRP_MJ_CREATE명령어를 처리하...</p></div></div></a></div><div class="card"> <a href="/posts/Build_driver/"><div class="card-body"> <span class="timeago small" > Aug 24, 2020 <i class="unloaded">2020-08-24T18:30:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Driver 빌드하기</h3><div class="text-muted small"><p> 드라이버의 빌드과정은 일반적인 프로그램 제작과는 조금 다른 과정을 거칩니다. Visual studio에서 inf빌드가 가능하지만 안정성을 이유로 EWDK를 사용하여 빌드과정을 거칩니다. Microsoft 설치파일배포 페이지에서 EWDK를 다운받을 수 있습니다. EWDK downalod page WDK와 버전을 맞춰 EWDK를 다운로드 한 뒤 마운트...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/wdm_Terminology/" class="btn btn-outline-primary" prompt="Older"><p>WDM 용어 정리</p></a> <a href="/posts/Build_driver/" class="btn btn-outline-primary" prompt="Newer"><p>Driver 빌드하기</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://github.com/Jooss287">Jooss287</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/windows-driver/">windows driver</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/django/">django</a> <a class="post-tag" href="/tags/env-setting/">env setting</a> <a class="post-tag" href="/tags/commit/">commit</a> <a class="post-tag" href="/tags/tomcat/">tomcat</a> <a class="post-tag" href="/tags/unit-test/">unit test</a> <a class="post-tag" href="/tags/boost/">boost</a> <a class="post-tag" href="/tags/class/">class</a> <a class="post-tag" href="/tags/etc-recording/">etc recording</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://Jooss287.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
